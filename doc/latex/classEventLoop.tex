\hypertarget{classEventLoop}{}\doxysection{Event\+Loop类 参考}
\label{classEventLoop}\index{EventLoop@{EventLoop}}


Waits for events on file descriptors and executes corresponding callbacks.  




{\ttfamily \#include $<$eventloop.\+hh$>$}

\doxysubsection*{Public 类型}
\begin{DoxyCompactItemize}
\item 
enum \mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9b}{Direction}} \+: short \{ \mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9baefeb369cccbd560588a756610865664c}{Direction\+::\+In}} = P\+O\+L\+L\+IN, 
\mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9ba7c147cda9e49590f6abe83d118b7353b}{Direction\+::\+Out}} = P\+O\+L\+L\+O\+UT
 \}
\begin{DoxyCompactList}\small\item\em Indicates interest in reading (In) or writing (Out) a polled fd. \end{DoxyCompactList}\item 
enum \mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11ef}{Result}} \{ \mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11efa505a83f220c02df2f85c3810cd9ceb38}{Result\+::\+Success}}, 
\mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11efac85a251cc457840f1e032f1b733e9398}{Result\+::\+Timeout}}, 
\mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11efafef46e5063ce3dc78b8ae64fa474241d}{Result\+::\+Exit}}
 \}
\begin{DoxyCompactList}\small\item\em Returned by each call to \mbox{\hyperlink{classEventLoop_a90ab8455d37b682d5b8b8bad5ae96daf}{Event\+Loop\+::wait\+\_\+next\+\_\+event}}. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsection*{Public 成员函数}
\begin{DoxyCompactItemize}
\item 
void \mbox{\hyperlink{classEventLoop_a5692e0e50828af7b80f4b9f1e480ba2c}{add\+\_\+rule}} (const \mbox{\hyperlink{classFileDescriptor}{File\+Descriptor}} \&fd, const \mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9b}{Direction}} direction, const CallbackT \&callback, const InterestT \&interest=\mbox{[}$\,$\mbox{]} \{ return true;\}, const CallbackT \&cancel=\mbox{[}$\,$\mbox{]} \{\})
\begin{DoxyCompactList}\small\item\em Add a rule whose callback will be called when {\ttfamily fd} is ready in the specified Direction. \end{DoxyCompactList}\item 
\mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11ef}{Result}} \mbox{\hyperlink{classEventLoop_a90ab8455d37b682d5b8b8bad5ae96daf}{wait\+\_\+next\+\_\+event}} (const int timeout\+\_\+ms)
\begin{DoxyCompactList}\small\item\em Calls poll(2) and then executes callback for each ready fd. \end{DoxyCompactList}\end{DoxyCompactItemize}


\doxysubsection{详细描述}
Waits for events on file descriptors and executes corresponding callbacks. 

An \mbox{\hyperlink{classEventLoop}{Event\+Loop}} holds a std\+::list of Rule objects. Each time \mbox{\hyperlink{classEventLoop_a90ab8455d37b682d5b8b8bad5ae96daf}{Event\+Loop\+::wait\+\_\+next\+\_\+event}} is executed, the \mbox{\hyperlink{classEventLoop}{Event\+Loop}} uses the Rule objects to construct a call to poll(2).

When a Rule is installed using \mbox{\hyperlink{classEventLoop_a5692e0e50828af7b80f4b9f1e480ba2c}{Event\+Loop\+::add\+\_\+rule}}, it will be polled for the specified Rule\+::direction whenver the Rule\+::interest callback returns {\ttfamily true}, until Rule\+::fd is no longer readable (for Rule\+::direction == \mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9baefeb369cccbd560588a756610865664c}{Direction\+::\+In}}) or writable (for Rule\+::direction == \mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9ba7c147cda9e49590f6abe83d118b7353b}{Direction\+::\+Out}}). Once this occurs, the Rule is canceled, i.\+e., the \mbox{\hyperlink{classEventLoop}{Event\+Loop}} deletes it.

A Rule installed using Event\+Loop\+::add\+\_\+cancelable\+\_\+rule will be polled and canceled under the same conditions, with the additional condition that if Rule\+::callback returns {\ttfamily true}, the Rule will be canceled. 

在文件 eventloop.\+hh 第 12 行定义.



\doxysubsection{成员枚举类型说明}
\mbox{\Hypertarget{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9b}\label{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9b}} 
\index{EventLoop@{EventLoop}!Direction@{Direction}}
\index{Direction@{Direction}!EventLoop@{EventLoop}}
\doxysubsubsection{\texorpdfstring{Direction}{Direction}}
{\footnotesize\ttfamily enum \mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9b}{Event\+Loop\+::\+Direction}} \+: short\hspace{0.3cm}{\ttfamily [strong]}}



Indicates interest in reading (In) or writing (Out) a polled fd. 

\begin{DoxyEnumFields}{枚举值}
\raisebox{\heightof{T}}[0pt][0pt]{\index{In@{In}!EventLoop@{EventLoop}}\index{EventLoop@{EventLoop}!In@{In}}}\mbox{\Hypertarget{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9baefeb369cccbd560588a756610865664c}\label{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9baefeb369cccbd560588a756610865664c}} 
In&Callback will be triggered when Rule\+::fd is readable. \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{Out@{Out}!EventLoop@{EventLoop}}\index{EventLoop@{EventLoop}!Out@{Out}}}\mbox{\Hypertarget{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9ba7c147cda9e49590f6abe83d118b7353b}\label{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9ba7c147cda9e49590f6abe83d118b7353b}} 
Out&Callback will be triggered when Rule\+::fd is writable. \\
\hline

\end{DoxyEnumFields}


在文件 eventloop.\+hh 第 15 行定义.

\mbox{\Hypertarget{classEventLoop_a546fea46598ab3b00e5959bc42bb11ef}\label{classEventLoop_a546fea46598ab3b00e5959bc42bb11ef}} 
\index{EventLoop@{EventLoop}!Result@{Result}}
\index{Result@{Result}!EventLoop@{EventLoop}}
\doxysubsubsection{\texorpdfstring{Result}{Result}}
{\footnotesize\ttfamily enum \mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11ef}{Event\+Loop\+::\+Result}}\hspace{0.3cm}{\ttfamily [strong]}}



Returned by each call to \mbox{\hyperlink{classEventLoop_a90ab8455d37b682d5b8b8bad5ae96daf}{Event\+Loop\+::wait\+\_\+next\+\_\+event}}. 

\begin{DoxyEnumFields}{枚举值}
\raisebox{\heightof{T}}[0pt][0pt]{\index{Success@{Success}!EventLoop@{EventLoop}}\index{EventLoop@{EventLoop}!Success@{Success}}}\mbox{\Hypertarget{classEventLoop_a546fea46598ab3b00e5959bc42bb11efa505a83f220c02df2f85c3810cd9ceb38}\label{classEventLoop_a546fea46598ab3b00e5959bc42bb11efa505a83f220c02df2f85c3810cd9ceb38}} 
Success&At least one Rule was triggered. \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{Timeout@{Timeout}!EventLoop@{EventLoop}}\index{EventLoop@{EventLoop}!Timeout@{Timeout}}}\mbox{\Hypertarget{classEventLoop_a546fea46598ab3b00e5959bc42bb11efac85a251cc457840f1e032f1b733e9398}\label{classEventLoop_a546fea46598ab3b00e5959bc42bb11efac85a251cc457840f1e032f1b733e9398}} 
Timeout&No rules were triggered before timeout. \\
\hline

\raisebox{\heightof{T}}[0pt][0pt]{\index{Exit@{Exit}!EventLoop@{EventLoop}}\index{EventLoop@{EventLoop}!Exit@{Exit}}}\mbox{\Hypertarget{classEventLoop_a546fea46598ab3b00e5959bc42bb11efafef46e5063ce3dc78b8ae64fa474241d}\label{classEventLoop_a546fea46598ab3b00e5959bc42bb11efafef46e5063ce3dc78b8ae64fa474241d}} 
Exit&All rules have been canceled or were uninterested; make no further calls to \mbox{\hyperlink{classEventLoop_a90ab8455d37b682d5b8b8bad5ae96daf}{Event\+Loop\+::wait\+\_\+next\+\_\+event}}. \\
\hline

\end{DoxyEnumFields}


在文件 eventloop.\+hh 第 43 行定义.



\doxysubsection{成员函数说明}
\mbox{\Hypertarget{classEventLoop_a5692e0e50828af7b80f4b9f1e480ba2c}\label{classEventLoop_a5692e0e50828af7b80f4b9f1e480ba2c}} 
\index{EventLoop@{EventLoop}!add\_rule@{add\_rule}}
\index{add\_rule@{add\_rule}!EventLoop@{EventLoop}}
\doxysubsubsection{\texorpdfstring{add\_rule()}{add\_rule()}}
{\footnotesize\ttfamily void Event\+Loop\+::add\+\_\+rule (\begin{DoxyParamCaption}\item[{const \mbox{\hyperlink{classFileDescriptor}{File\+Descriptor}} \&}]{fd,  }\item[{const \mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9b}{Direction}}}]{direction,  }\item[{const CallbackT \&}]{callback,  }\item[{const InterestT \&}]{interest = {\ttfamily \mbox{[}\mbox{]}~\{~return~true;~\}},  }\item[{const CallbackT \&}]{cancel = {\ttfamily \mbox{[}\mbox{]}~\{\}} }\end{DoxyParamCaption})}



Add a rule whose callback will be called when {\ttfamily fd} is ready in the specified Direction. 


\begin{DoxyParams}[1]{参数}
\mbox{\texttt{ in}}  & {\em fd} & is the \mbox{\hyperlink{classFileDescriptor}{File\+Descriptor}} to be polled \\
\hline
\mbox{\texttt{ in}}  & {\em direction} & indicates whether to poll for reading (\mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9baefeb369cccbd560588a756610865664c}{Direction\+::\+In}}) or writing (\mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9ba7c147cda9e49590f6abe83d118b7353b}{Direction\+::\+Out}}) \\
\hline
\mbox{\texttt{ in}}  & {\em callback} & is called when {\ttfamily fd} is ready. \\
\hline
\mbox{\texttt{ in}}  & {\em interest} & is called by \mbox{\hyperlink{classEventLoop_a90ab8455d37b682d5b8b8bad5ae96daf}{Event\+Loop\+::wait\+\_\+next\+\_\+event}}. If it returns {\ttfamily true}, {\ttfamily fd} will be polled, otherwise {\ttfamily fd} will be ignored only for this execution of \`{}wait\+\_\+next\+\_\+event. \\
\hline
\mbox{\texttt{ in}}  & {\em cancel} & is called when the rule is cancelled (e.\+g. on hangup, E\+OF, or closure). \\
\hline
\end{DoxyParams}


在文件 eventloop.\+cc 第 23 行定义.

\mbox{\Hypertarget{classEventLoop_a90ab8455d37b682d5b8b8bad5ae96daf}\label{classEventLoop_a90ab8455d37b682d5b8b8bad5ae96daf}} 
\index{EventLoop@{EventLoop}!wait\_next\_event@{wait\_next\_event}}
\index{wait\_next\_event@{wait\_next\_event}!EventLoop@{EventLoop}}
\doxysubsubsection{\texorpdfstring{wait\_next\_event()}{wait\_next\_event()}}
{\footnotesize\ttfamily \mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11ef}{Event\+Loop\+::\+Result}} Event\+Loop\+::wait\+\_\+next\+\_\+event (\begin{DoxyParamCaption}\item[{const int}]{timeout\+\_\+ms }\end{DoxyParamCaption})}



Calls poll(2) and then executes callback for each ready fd. 


\begin{DoxyParams}[1]{参数}
\mbox{\texttt{ in}}  & {\em timeout\+\_\+ms} & is the timeout value passed to poll(2); {\ttfamily wait\+\_\+next\+\_\+event} returns \mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11efac85a251cc457840f1e032f1b733e9398}{Result\+::\+Timeout}} if no fd is ready after the timeout expires. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{返回}
Eventloop\+::\+Result indicating success, timeout, or no more Rule objects to poll.
\end{DoxyReturn}
For each Rule, this function first calls Rule\+::interest; if {\ttfamily true}, Rule\+::fd is added to the list of file descriptors to be polled for readability (if Rule\+::direction == \mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9baefeb369cccbd560588a756610865664c}{Direction\+::\+In}}) or writability (if Rule\+::direction == \mbox{\hyperlink{classEventLoop_aacf9274eb319e0828ecb4f6760b7ab9ba7c147cda9e49590f6abe83d118b7353b}{Direction\+::\+Out}}) unless Rule\+::fd has reached E\+OF, in which case the Rule is canceled (i.\+e., deleted from Event\+Loop\+::\+\_\+rules).

Next, this function calls poll(2) with timeout value {\ttfamily timeout\+\_\+ms}.

Then, for each ready file descriptor, this function calls Rule\+::callback. If fd reaches E\+OF or if the Rule was registered using Event\+Loop\+::add\+\_\+cancelable\+\_\+rule and Rule\+::callback returns true, this Rule is canceled.

If an error occurs during polling, this function throws a std\+::runtime\+\_\+error.

If a signal(7) was caught during polling or if Event\+Loop\+::\+\_\+rules becomes empty, this function returns \mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11efafef46e5063ce3dc78b8ae64fa474241d}{Result\+::\+Exit}}.

If a timeout occurred while polling (i.\+e., no fd became ready), this function returns \mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11efac85a251cc457840f1e032f1b733e9398}{Result\+::\+Timeout}}.

Otherwise, this function returns \mbox{\hyperlink{classEventLoop_a546fea46598ab3b00e5959bc42bb11efa505a83f220c02df2f85c3810cd9ceb38}{Result\+::\+Success}}.

{\bfseries{I\+M\+P\+O\+R\+T\+A\+NT\+:}} every call to Rule\+::callback must read from or write to Rule\+::fd, or the {\ttfamily interest} callback must stop returning true after the callback completes. If none of these conditions occur, \mbox{\hyperlink{classEventLoop_a90ab8455d37b682d5b8b8bad5ae96daf}{Event\+Loop\+::wait\+\_\+next\+\_\+event}} will throw std\+::runtime\+\_\+error. This is because poll(2) is level triggered, so failing to act on a ready file descriptor will result in a busy loop (poll returns on a ready file descriptor; file descriptor is not read or written, so it is still ready; the next call to poll will immediately return). 

在文件 eventloop.\+cc 第 61 行定义.



该类的文档由以下文件生成\+:\begin{DoxyCompactItemize}
\item 
libsponge/util/eventloop.\+hh\item 
libsponge/util/eventloop.\+cc\end{DoxyCompactItemize}
